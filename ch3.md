# 3. 스프링 클라우드 컨피그 서버로 구성관리
> 클라우드 기반 마이크로서비스 개발에서는 다음과 같은 사항이 강조된다.

1. 배포되는 실제 코드에서 애플리케이션의 구성을 완전하게 분리한다.
2. 서버 및 애플리케이션을 빌드하고 배포 환경에 따라 절대 바뀌지 않는 불변 이미지를 빌드한다.
3. 서버를 시작할 때 환경 변수나 애플리케이션의 마이크로서비스가 읽어 올 수 있는 중앙 저장소를 이용해 애플리케이션 구성 정보를 주입한다.

## 3.1 구성(그리고 복잡성) 관리
> 마이크로서비스의 인스턴스는 사람이 최소한으로 개입해 신속하게 시작해야하므로 구성관리는 매우 중요하며, 다음 4가지 원칙을 따른다.

1. 분리(segregate) : 물리적인 서비스의 배포와 서비스 구성 정보를 완전히 분리해야 한다.  
2. 추상화(abstract) : 구성 데이터의 접근 방식을 추상화한다. 저장소에 직접 엑세스하는 코드보다 REST 기반의 JSON 서비스를 사용해 구성 데이터를 조회해야 한다.
3. 중앙 집중화(centralize) : 애플리케이션의 구성 정보를 가능한 소수 저장소에 집중화한다.
4. 견고성(harden) : 어떤 솔루션을 사용하더라도 고가용성과 다중성을 구현할 수 있어야 한다.

#### 3.1.1 구성 관리 아키텍처
> 마이크로서비스를 위한 구성 관리는 마이크로서비스의 부트스트래핑 단계에서 일어나며, 단계는 다음과 같다.

1. 인스턴스가 시작하면 서비스 엔드포인트를 호출해 환경별 구성 정보를 읽어 온다.
2. 실제 구성 정보는 저장소에 상주한다.
3. 애플리케이션 배포 방식과 독립적으로 애플리케이션의 구성 데이터를 관리한다.
4. 구성 관리가 변경되면 애플리케이션 구성 데이터를 사용하는 서비스는 변경 통보를 받고 보유한 애플리케이션 데이터 사본을 갱샌해야 한다.


#### 3.1.2 구현 선택
> 구성 관리 솔루션 구현은 다음과 같은 프로젝트 중에서 하나를 고를 수 있다.

1. Etcd
2. 유레카 (Eureka)
3. 콘설 (Consul)
4. 주키퍼 (Zookeeper)
5. 스프링 클라우드 컨피그 서버 (Spring Cloud Config Server)

```
스프링 클라우드 컨피그 서버는 깃 소스 제어 플랫폼과 직접 통합할 수 있어. 자체 버전관리 기능을 구축해야 하는 다른 프로젝트들에 비해 매력적이다.
```

## 3.2 스프링 클라우드 컨피그 서버 구축
> 스프링 클라우드 컨피그 서버는 스프링 부트로 만든 REST 기반의 애플리케이션이며, 동작하게 하려면 다음과 같은 파일을 설정해야 한다.

1. application.yml : 컨피그 서버가 수신 대기할 포트, 구성 데이터를 제공하는 백엔드 위치 등의 정보를 명시한다.

#### 3.2.1 스프링 클라우드 컨피그 부트스트랩 클래스 설정
> @EnableConfigServer 어노테이션을 붙이면 끝

## 3.3 스프링 클라우드 컨피그와 스프링 부트 클라이언트의 통합

1. MSA 서비스 인스턴스가 부트스트래핑 할 때 1) 스프링 프로파일 과 2) 스프링 클라우드 서비스 통신에 사용할 엔드포인트를 전달 한다.
2. 전달받은 프로파일과 앤드포인트를 사용해 스프링 클라우드 컨피그 서비스와 통신한다.
3. 스프링 클라우드 컨피그 서비스는 해당하는 구성정보를 구성 저장소(Git) 에서 조회한 후 적절한 값을 MSA 인스턴스에 되돌려 준다.  

#### 3.3.1 스프링 클라우드 컨피그 서버의 의존성 설정 

[Spring Cloud 2020.0 주요 변경](https://stackoverflow.com/questions/65063402/why-bootstrap-properties-is-ignored-by-spring-cloud-starter-config)

```
implementation 'org.springframework.cloud:spring-cloud-config-client'
```

#### 3.3.2 스프링 클라우드 컨피그를 위한 서비스 구성
> bootstrap.yml 파일은 구성 정보가 사용되기 전에 애플리케이션 프로퍼티를 먼저 읽는다.

1. 일반적으로 bootstrap.yml 파일에 서비스 애플리케이션 이름, 애플리케이션 프로파일과 스프링 클라우드 컨피그 서버에 접속할 수 있는 URI 가 명시된다.
   - spring.application.name : 애플리케이션 이름이며 스프링 클라우드 컨피그 서버의 디렉터리 이름과 일치해야 한다.
   - spring.profiles.active : 애플리케이션이 어떤 프로파일로 실행될지 알려준다.
   - spring.cloud.config.uri : 애플리케이션이 접속할 스프링 클라우드 컨피그 서버의 엔드포인트이다.


2. 로컬에 유지하고 싶은 서비스 구성 정보는 application.yml 파일에 설정할 수 있다.

3. 실행 후 http://localhost:8080/actuactor/env 엔드포인트를 호출하면 실행 중인 환경 정보를 확인할 수 있다. 
[endpoint 설정 방법](https://stackoverflow.com/questions/60131767/spring-actuator-endpoints-giving-404-error-except-for-health-and-info)

> 보안적인 이슈로 인해 /env 엔드 포인트는 활성화 하지 말아야 한다.

#### 3.3.3 스프링 클라우드 컨피그 서버로 데이터 소스 연결

#### 3.3.4 @Value 애너테이션으로 프로퍼티 직접 읽기
> value 어노테이션을 사용하면 스프링 클라우드 컨피그 서버의 설정 값을 직접 주입해 사용할 수 있다.

#### 3.3.6 스프링 클라우드 컨피그 서버에서 프로퍼티 갱신
> 스프링 클라우드 컨피그는 항상 최신 버전의 프로티를 제공한다. 따라서 하부 저장소의 프로퍼티를 변경하면 바로 반영된다.

vs

> 스프링 부트 어플리케이션은 시작할 때만 프로퍼티를 읽어 오며, 컨피그 서버에서 변경된 프로퍼티를 자동으로 읽어 오지 않는다.

스프링 부트 액추에이터는 @RefreshScope 애너테이션을 제공하므로 스프링 부트 애플리케이션이 /refresh 엔드포인트를 사용해 애플리케이션 구성 정보를 다시 읽어 올 수 있다.

- 사용자 정의 스프링 프로퍼티만 다시 로드한다. (데이터베이스 구성 정보처럼 스프링에 정의된 구성은 x)
- 업데이트를 수행하기 위해 http://<yourserver>:8080/actuator/refresh 엔드 포인트를 호출한다.
- 인스턴스 구성 정보 업데이트를 하는 방법에는 많은 방법이 있지만.. 새로운 구성으로 새로운 인스턴스를 시작하는 것을 추천한다.  

## 3.4 중요한 구성 정보
> 스프링 클라우드 컨피그는 중요한 프로퍼티를 쉽게 암호화할 수 있는 기능을 제공하며 대칭 및 비대칭 암호화를 모두 지원한다.

#### 3.4.1 암호화에 필요한 오라클 JCE jar 파일을 내려받아 설치
> JAVA 8 update 151 부터는 [환경 설정](https://stackoverflow.com/questions/37741142/how-to-install-unlimited-strength-jce-for-java-8-in-os-x/45055461) 으로 대체할 수 있다.

#### 3.4.2 암호화 키 설정
#### 3.4.3 프로퍼티 암호화 및 복호화
#### 3.4.4 클라이언트 측에서 암호화하도록 마이크로서비스 구성 
